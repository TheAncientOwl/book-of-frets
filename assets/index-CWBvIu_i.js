import{j as r,a7 as t,ac as e,am as n,I as o,ak as s,a8 as i,an as a}from"./chakra-layout-L_gDgE6-.js";import{r as u,g as l}from"./react-Dawx916Q.js";import{a as h,F as f,b as c,d,L as m}from"./index-TYcMsjye.js";import{d as p,D as _}from"./chakra-fNkxOzZ9.js";import{S as g,n as b,o as y,T as v,p as x}from"./chakra-effects-BsFb7mkt.js";import"./emotion-D3_1FDPY.js";import"./chakra-theme-B6BH3K5N.js";import"./framer-motion-CrfrA4r2.js";var w,A;const j=l(function(){if(A)return w;function r(r){if(this.size=0|r,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=r<<1;for(var t=new Array(2*this.size),e=0;e<t.length;e+=2){const r=Math.PI*e/this.size;t[e]=Math.cos(r),t[e+1]=-Math.sin(r)}this.table=t;for(var n=0,o=1;this.size>o;o<<=1)n++;this._width=n%2==0?n-1:n,this._bitrev=new Array(1<<this._width);for(var s=0;s<this._bitrev.length;s++){this._bitrev[s]=0;for(var i=0;i<this._width;i+=2){var a=this._width-i-2;this._bitrev[s]|=(s>>>i&3)<<a}}this._out=null,this._data=null,this._inv=0}return A=1,w=r,r.prototype.fromComplexArray=function(r,t){for(var e=t||new Array(r.length>>>1),n=0;n<r.length;n+=2)e[n>>>1]=r[n];return e},r.prototype.createComplexArray=function(){const r=new Array(this._csize);for(var t=0;t<r.length;t++)r[t]=0;return r},r.prototype.toComplexArray=function(r,t){for(var e=t||this.createComplexArray(),n=0;n<e.length;n+=2)e[n]=r[n>>>1],e[n+1]=0;return e},r.prototype.completeSpectrum=function(r){for(var t=this._csize,e=t>>>1,n=2;n<e;n+=2)r[t-n]=r[n],r[t-n+1]=-r[n+1]},r.prototype.transform=function(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null},r.prototype.realTransform=function(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null},r.prototype.inverseTransform=function(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=1,this._transform4();for(var e=0;e<r.length;e++)r[e]/=this.size;this._out=null,this._data=null},r.prototype._transform4=function(){var r,t,e=this._out,n=this._csize,o=1<<this._width,s=n/o<<1,i=this._bitrev;if(4===s)for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleTransform2(r,e,o)}else for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleTransform4(r,e,o)}var a=this._inv?-1:1,u=this.table;for(o>>=2;o>=2;o>>=2){var l=(s=n/o<<1)>>>2;for(r=0;r<n;r+=s)for(var h=r+l,f=r,c=0;f<h;f+=2,c+=o){const r=f,t=r+l,n=t+l,o=n+l,s=e[r],i=e[r+1],h=e[t],d=e[t+1],m=e[n],p=e[n+1],_=e[o],g=e[o+1],b=s,y=i,v=u[c],x=a*u[c+1],w=h*v-d*x,A=h*x+d*v,j=u[2*c],S=a*u[2*c+1],T=m*j-p*S,B=m*S+p*j,C=u[3*c],k=a*u[3*c+1],z=_*C-g*k,F=_*k+g*C,I=b+T,q=y+B,E=b-T,M=y-B,R=w+z,P=A+F,D=a*(w-z),V=a*(A-F),$=I+R,L=q+P,N=I-R,W=q-P,H=E+V,G=M-D,J=E-V,O=M+D;e[r]=$,e[r+1]=L,e[t]=H,e[t+1]=G,e[n]=N,e[n+1]=W,e[o]=J,e[o+1]=O}}},r.prototype._singleTransform2=function(r,t,e){const n=this._out,o=this._data,s=o[t],i=o[t+1],a=o[t+e],u=o[t+e+1],l=s+a,h=i+u,f=s-a,c=i-u;n[r]=l,n[r+1]=h,n[r+2]=f,n[r+3]=c},r.prototype._singleTransform4=function(r,t,e){const n=this._out,o=this._data,s=this._inv?-1:1,i=2*e,a=3*e,u=o[t],l=o[t+1],h=o[t+e],f=o[t+e+1],c=o[t+i],d=o[t+i+1],m=o[t+a],p=o[t+a+1],_=u+c,g=l+d,b=u-c,y=l-d,v=h+m,x=f+p,w=s*(h-m),A=s*(f-p),j=_+v,S=g+x,T=b+A,B=y-w,C=_-v,k=g-x,z=b-A,F=y+w;n[r]=j,n[r+1]=S,n[r+2]=T,n[r+3]=B,n[r+4]=C,n[r+5]=k,n[r+6]=z,n[r+7]=F},r.prototype._realTransform4=function(){var r,t,e=this._out,n=this._csize,o=1<<this._width,s=n/o<<1,i=this._bitrev;if(4===s)for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleRealTransform2(r,e>>>1,o>>>1)}else for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleRealTransform4(r,e>>>1,o>>>1)}var a=this._inv?-1:1,u=this.table;for(o>>=2;o>=2;o>>=2){var l=(s=n/o<<1)>>>1,h=l>>>1,f=h>>>1;for(r=0;r<n;r+=s)for(var c=0,d=0;c<=f;c+=2,d+=o){var m=r+c,p=m+h,_=p+h,g=_+h,b=e[m],y=e[m+1],v=e[p],x=e[p+1],w=e[_],A=e[_+1],j=e[g],S=e[g+1],T=b,B=y,C=u[d],k=a*u[d+1],z=v*C-x*k,F=v*k+x*C,I=u[2*d],q=a*u[2*d+1],E=w*I-A*q,M=w*q+A*I,R=u[3*d],P=a*u[3*d+1],D=j*R-S*P,V=j*P+S*R,$=T+E,L=B+M,N=T-E,W=B-M,H=z+D,G=F+V,J=a*(z-D),O=a*(F-V),U=$+H,K=L+G,Q=N+O,X=W-J;if(e[m]=U,e[m+1]=K,e[p]=Q,e[p+1]=X,0!==c){if(c!==f){var Y=N+-a*O,Z=-W+-a*J,rr=$+-a*H,tr=-L- -a*G,er=r+h-c,nr=r+l-c;e[er]=Y,e[er+1]=Z,e[nr]=rr,e[nr+1]=tr}}else{var or=$-H,sr=L-G;e[_]=or,e[_+1]=sr}}}},r.prototype._singleRealTransform2=function(r,t,e){const n=this._out,o=this._data,s=o[t],i=o[t+e],a=s+i,u=s-i;n[r]=a,n[r+1]=0,n[r+2]=u,n[r+3]=0},r.prototype._singleRealTransform4=function(r,t,e){const n=this._out,o=this._data,s=this._inv?-1:1,i=2*e,a=3*e,u=o[t],l=o[t+e],h=o[t+i],f=o[t+a],c=u+h,d=u-h,m=l+f,p=s*(l-f),_=c+m,g=d,b=-p,y=c-m,v=d,x=p;n[r]=_,n[r+1]=0,n[r+2]=g,n[r+3]=b,n[r+4]=y,n[r+5]=0,n[r+6]=v,n[r+7]=x},w}());class S{_inputLength;_fft;_bufferSupplier;_paddedInputBuffer;_transformBuffer;_inverseBuffer;static forFloat32Array(r){return new S(r,r=>new Float32Array(r))}static forFloat64Array(r){return new S(r,r=>new Float64Array(r))}static forNumberArray(r){return new S(r,r=>Array(r))}constructor(r,t){if(r<1)throw new Error("Input length must be at least one");var e;this._inputLength=r,this._fft=new j((e=2*r,e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}get inputLength(){return this._inputLength}autocorrelate(r,t=this._bufferSupplier(r.length)){if(r.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${r.length}`);for(let n=0;n<r.length;n++)this._paddedInputBuffer[n]=r[n];for(let n=r.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const e=this._transformBuffer;for(let n=0;n<e.length;n+=2)e[n]=e[n]*e[n]+e[n+1]*e[n+1],e[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<r.length;n++)t[n]=this._inverseBuffer[2*n];return t}}class T{_autocorrelator;_nsdfBuffer;_clarityThreshold=.9;_minVolumeAbsolute=0;_maxInputAmplitude=1;static forFloat32Array(r){return new T(r,r=>new Float32Array(r))}static forFloat64Array(r){return new T(r,r=>new Float64Array(r))}static forNumberArray(r){return new T(r,r=>Array(r))}constructor(r,t){this._autocorrelator=new S(r,t),this._nsdfBuffer=t(r)}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(r){if(!Number.isFinite(r)||r<=0||r>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=r}set minVolumeAbsolute(r){if(!Number.isFinite(r)||r<0||r>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=r}set minVolumeDecibels(r){if(!Number.isFinite(r)||r>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(r/10)}set maxInputAmplitude(r){if(!Number.isFinite(r)||r<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=r}findPitch(r,t){if(this._belowMinimumVolume(r))return[0,0];this._nsdf(r);const e=function(r){const t=[];let e=!1,n=-1/0,o=-1;for(let s=1;s<r.length-1;s++)r[s-1]<=0&&r[s]>0?(e=!0,o=s,n=r[s]):r[s-1]>0&&r[s]<=0?(e=!1,-1!==o&&t.push(o)):e&&r[s]>n&&(n=r[s],o=s);return t}(this._nsdfBuffer);if(0===e.length)return[0,0];const n=Math.max(...e.map(r=>this._nsdfBuffer[r])),o=e.find(r=>this._nsdfBuffer[r]>=this._clarityThreshold*n),[s,i]=function(r,t){const[e,n,o]=[r-1,r,r+1],[s,i,a]=[t[e],t[n],t[o]],u=s/2-i+a/2,l=-s/2*(n+o)+i*(e+o)-a/2*(e+n),h=-l/(2*u);return[h,u*h*h+l*h+(s*n*o/2-i*e*o+a*e*n/2)]}(o,this._nsdfBuffer);return[t/s,Math.min(i,1)]}_belowMinimumVolume(r){if(0===this._minVolumeAbsolute)return!1;let t=0;for(let e=0;e<r.length;e++)t+=r[e]**2;return Math.sqrt(t/r.length)<this._minVolumeAbsolute}_nsdf(r){this._autocorrelator.autocorrelate(r,this._nsdfBuffer);let t,e=2*this._nsdfBuffer[0];for(t=0;t<this._nsdfBuffer.length&&e>0;t++)this._nsdfBuffer[t]=2*this._nsdfBuffer[t]/e,e-=r[t]**2+r[r.length-t-1]**2;for(;t<this._nsdfBuffer.length;t++)this._nsdfBuffer[t]=0}}const B=r=>{const[t,e]=u.useState("-"),[n,o]=u.useState(null),[s,i]=u.useState(!1),a=u.useRef(null),l=u.useRef(null),h=u.useRef(null),f=u.useRef(null),c=u.useRef(null),d=u.useRef(null),m=()=>{if(!(a.current&&l.current&&h.current&&f.current))return;const t=l.current,n=h.current,s=f.current;t.getFloatTimeDomainData(s);const[i,u]=n.findPitch(s,a.current.sampleRate);i&&u>.9&&(o(i),e(((r,t)=>{let e=t[0],n=Math.abs(r-e.freq);for(const o of t){const t=Math.abs(r-o.freq);t<n&&(e=o,n=t)}return e.name})(i,r))),c.current=requestAnimationFrame(m)};return{note:t,frequency:n,isRunning:s,startTuner:async()=>{if(!s)try{const r=await navigator.mediaDevices.getUserMedia({audio:!0});d.current=r;const t=new AudioContext;a.current=t;const e=t.createMediaStreamSource(r),n=t.createAnalyser();n.fftSize=2048,l.current=n,e.connect(n);const o=T.forFloat32Array(n.fftSize);h.current=o,f.current=new Float32Array(n.fftSize),i(!0),m()}catch(r){alert(`[!] Error accessing microphone: ${r}`),console.error("Error accessing microphone",r)}},stopTuner:()=>{s&&(null!==c.current&&cancelAnimationFrame(c.current),a.current?.close(),d.current?.getTracks().forEach(r=>r.stop()),c.current=null,a.current=null,d.current=null,l.current=null,h.current=null,f.current=null,i(!1),e("-"),o(null))}}},C=t=>{const e=h(r=>r.appTheme.appMenu.items.tuner);return r.jsx(p,{"aria-label":"play-pause tuner",icon:t.isRunning?r.jsx(f,{}):r.jsx(c,{}),onClick:t.isRunning?t.onStop:t.onStart,mb:"10px",size:"lg",backgroundColor:e.controlButton.background,color:e.controlButton.color,_hover:{backgroundColor:e.controlButton.hover.background,color:e.controlButton.hover.color}})},k=e=>{const n=h(r=>r.appTheme.appMenu.items.tuner);return r.jsx(t,{...e.containerProps,fontWeight:"bold",color:n.frequencyDisplay.color,children:null!==e.freq?`(${e.freq?.toFixed(2)} Hz)`:"(0 Hz)"})},z=t=>{const s=h(r=>r.appTheme.appMenu.items.tuner),i=t.targetFreq-t.currentFreq,a=Math.abs(i),u=a<=t.threshold,l=i>0,f=u?s.frequencyProgressIndicator.matched:l?s.frequencyProgressIndicator.tuneUp:s.frequencyProgressIndicator.tuneDown;return r.jsx(e,{...t.containerProps,justifyContent:"center",children:r.jsx(n,{size:"12",borderWidth:"thin",fontWeight:"bold",color:f.color,backgroundColor:f.background,borderColor:f.border,children:t.active?u?r.jsx(o,{as:d}):`${l?"+":"-"}${a.toFixed(0)}`:"0"})})},F=t=>{const e=h(r=>r.appTheme.appMenu.items.tuner);return r.jsxs(s,{...t.containerProps,columns:[1,2],gap:"5px",children:[r.jsxs(i,{size:"sm",as:"h5",color:e.thresholdSlider.color,children:["Frequency Threshold",r.jsx("br",{})," ",t.threshold," Hz"]}),r.jsxs(g,{value:t.threshold,onChange:r=>t.onThresholdChange(r),min:0,max:5,step:.1,children:[r.jsx(b,{backgroundColor:e.thresholdSlider.slider.track,children:r.jsx(y,{backgroundColor:e.thresholdSlider.slider.filler})}),r.jsx(v,{label:`${t.threshold} Hz`,fontWeight:"bold",backgroundColor:e.thresholdSlider.slider.tooltip.background,color:e.thresholdSlider.slider.tooltip.color,children:r.jsx(x,{backgroundColor:e.thresholdSlider.slider.thumb})})]})]})},I=t=>{const o=h(r=>r.appTheme.appMenu.items.tuner),s=t.active?o.strings.active:o.strings.inactive;return r.jsxs(e,{direction:"column",alignItems:"center",justifyContent:"center",position:"relative",as:"button",onClick:t.onClick,children:[r.jsx(n,{size:"10",fontWeight:"bold",borderWidth:"3px",color:s.noteColor,borderColor:s.noteBorderColor,backgroundColor:s.backgroundColor,children:t.name}),r.jsx(_,{orientation:"vertical",height:"125px",borderWidth:"2px",borderColor:s.stringColor})]})},q=["E","A","D","G","B","e"],E=t=>r.jsx(e,{...t.containerProps,direction:"row",gap:"10px",justifyContent:"center",children:q.map((e,n)=>r.jsx(I,{name:e,active:e===t.activeString,onClick:()=>t.onStringClick(e)},n))}),M=[{name:"E2",freq:82.41},{name:"A2",freq:110},{name:"D3",freq:146.83},{name:"G3",freq:196},{name:"B3",freq:246.94},{name:"E4",freq:329.63}],R={E:0,A:1,D:2,G:3,B:4,e:5},P=()=>{const n=B(M),[o,s]=((r,t)=>{const[e,n]=u.useState(()=>{try{const e=window.localStorage.getItem(r);if(e){const r=JSON.parse(e);return"object"==typeof t&&null!==t&&"object"==typeof r&&null!==r&&!Array.isArray(t)&&Array.isArray(r),r}return t}catch(e){return console.warn(`Error reading localStorage key "${r}":`,e),t}});return u.useEffect(()=>{try{window.localStorage.setItem(r,JSON.stringify(e))}catch(t){console.warn(`Error setting localStorage key "${r}":`,t)}},[r,e]),[e,n]})(m.tunerThreshold,2),[i,l]=u.useState(null),f=h(r=>r.appTheme.appMenu.items.tuner);return r.jsxs(t,{textAlign:"center",borderRadius:"5px",children:[r.jsx(_,{borderColor:f.divider}),r.jsxs(a,{gridTemplateColumns:["1fr 1fr"],alignItems:"center",padding:"0 2rem",children:[r.jsx(t,{children:r.jsx(C,{isRunning:n.isRunning,onStart:()=>{n.startTuner(),l("E")},onStop:()=>{n.stopTuner(),l(null)}})}),r.jsxs(e,{direction:"column",padding:"1rem 0",children:[r.jsx(k,{freq:n.frequency,containerProps:{mb:"0.7rem"}}),r.jsx(z,{active:null!==i&&n.isRunning,currentFreq:n.frequency||0,targetFreq:M[R[i||"E"]].freq,threshold:o,containerProps:{mb:"1rem"}})]})]}),r.jsx(_,{borderColor:f.divider,mb:"1rem"}),r.jsx(E,{activeString:i,onStringClick:r=>l(r),containerProps:{mb:"1rem"}}),r.jsx(_,{borderColor:f.divider,mb:"1rem"}),r.jsx(F,{threshold:o,onThresholdChange:s})]})};export{P as GuitarTuner,P as default};
