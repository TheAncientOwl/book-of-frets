import{j as r,N as t,B as e,F as n,O as o,n as s,w as i,H as a,Q as u,R as l,W as h,x as f,X as c,i as d,Y as m}from"./chakra-DSmnQdPc.js";import{r as p,g as _}from"./react-Dawx916Q.js";import{a as g,F as b,b as y,d as v,L as x}from"./index-XzO3aS0C.js";import"./emotion-CkNWarJX.js";import"./framer-motion-C9kB9T2S.js";var w,A;const j=_(function(){if(A)return w;function r(r){if(this.size=0|r,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=r<<1;for(var t=new Array(2*this.size),e=0;e<t.length;e+=2){const r=Math.PI*e/this.size;t[e]=Math.cos(r),t[e+1]=-Math.sin(r)}this.table=t;for(var n=0,o=1;this.size>o;o<<=1)n++;this._width=n%2==0?n-1:n,this._bitrev=new Array(1<<this._width);for(var s=0;s<this._bitrev.length;s++){this._bitrev[s]=0;for(var i=0;i<this._width;i+=2){var a=this._width-i-2;this._bitrev[s]|=(s>>>i&3)<<a}}this._out=null,this._data=null,this._inv=0}return A=1,w=r,r.prototype.fromComplexArray=function(r,t){for(var e=t||new Array(r.length>>>1),n=0;n<r.length;n+=2)e[n>>>1]=r[n];return e},r.prototype.createComplexArray=function(){const r=new Array(this._csize);for(var t=0;t<r.length;t++)r[t]=0;return r},r.prototype.toComplexArray=function(r,t){for(var e=t||this.createComplexArray(),n=0;n<e.length;n+=2)e[n]=r[n>>>1],e[n+1]=0;return e},r.prototype.completeSpectrum=function(r){for(var t=this._csize,e=t>>>1,n=2;n<e;n+=2)r[t-n]=r[n],r[t-n+1]=-r[n+1]},r.prototype.transform=function(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null},r.prototype.realTransform=function(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null},r.prototype.inverseTransform=function(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=1,this._transform4();for(var e=0;e<r.length;e++)r[e]/=this.size;this._out=null,this._data=null},r.prototype._transform4=function(){var r,t,e=this._out,n=this._csize,o=1<<this._width,s=n/o<<1,i=this._bitrev;if(4===s)for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleTransform2(r,e,o)}else for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleTransform4(r,e,o)}var a=this._inv?-1:1,u=this.table;for(o>>=2;o>=2;o>>=2){var l=(s=n/o<<1)>>>2;for(r=0;r<n;r+=s)for(var h=r+l,f=r,c=0;f<h;f+=2,c+=o){const r=f,t=r+l,n=t+l,o=n+l,s=e[r],i=e[r+1],h=e[t],d=e[t+1],m=e[n],p=e[n+1],_=e[o],g=e[o+1],b=s,y=i,v=u[c],x=a*u[c+1],w=h*v-d*x,A=h*x+d*v,j=u[2*c],B=a*u[2*c+1],S=m*j-p*B,T=m*B+p*j,C=u[3*c],z=a*u[3*c+1],F=_*C-g*z,q=_*z+g*C,I=b+S,k=y+T,E=b-S,M=y-T,R=w+F,P=A+q,V=a*(w-F),D=a*(A-q),$=I+R,L=k+P,N=I-R,W=k-P,H=E+D,G=M-V,O=E-D,J=M+V;e[r]=$,e[r+1]=L,e[t]=H,e[t+1]=G,e[n]=N,e[n+1]=W,e[o]=O,e[o+1]=J}}},r.prototype._singleTransform2=function(r,t,e){const n=this._out,o=this._data,s=o[t],i=o[t+1],a=o[t+e],u=o[t+e+1],l=s+a,h=i+u,f=s-a,c=i-u;n[r]=l,n[r+1]=h,n[r+2]=f,n[r+3]=c},r.prototype._singleTransform4=function(r,t,e){const n=this._out,o=this._data,s=this._inv?-1:1,i=2*e,a=3*e,u=o[t],l=o[t+1],h=o[t+e],f=o[t+e+1],c=o[t+i],d=o[t+i+1],m=o[t+a],p=o[t+a+1],_=u+c,g=l+d,b=u-c,y=l-d,v=h+m,x=f+p,w=s*(h-m),A=s*(f-p),j=_+v,B=g+x,S=b+A,T=y-w,C=_-v,z=g-x,F=b-A,q=y+w;n[r]=j,n[r+1]=B,n[r+2]=S,n[r+3]=T,n[r+4]=C,n[r+5]=z,n[r+6]=F,n[r+7]=q},r.prototype._realTransform4=function(){var r,t,e=this._out,n=this._csize,o=1<<this._width,s=n/o<<1,i=this._bitrev;if(4===s)for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleRealTransform2(r,e>>>1,o>>>1)}else for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleRealTransform4(r,e>>>1,o>>>1)}var a=this._inv?-1:1,u=this.table;for(o>>=2;o>=2;o>>=2){var l=(s=n/o<<1)>>>1,h=l>>>1,f=h>>>1;for(r=0;r<n;r+=s)for(var c=0,d=0;c<=f;c+=2,d+=o){var m=r+c,p=m+h,_=p+h,g=_+h,b=e[m],y=e[m+1],v=e[p],x=e[p+1],w=e[_],A=e[_+1],j=e[g],B=e[g+1],S=b,T=y,C=u[d],z=a*u[d+1],F=v*C-x*z,q=v*z+x*C,I=u[2*d],k=a*u[2*d+1],E=w*I-A*k,M=w*k+A*I,R=u[3*d],P=a*u[3*d+1],V=j*R-B*P,D=j*P+B*R,$=S+E,L=T+M,N=S-E,W=T-M,H=F+V,G=q+D,O=a*(F-V),J=a*(q-D),U=$+H,Q=L+G,X=N+J,Y=W-O;if(e[m]=U,e[m+1]=Q,e[p]=X,e[p+1]=Y,0!==c){if(c!==f){var K=N+-a*J,Z=-W+-a*O,rr=$+-a*H,tr=-L- -a*G,er=r+h-c,nr=r+l-c;e[er]=K,e[er+1]=Z,e[nr]=rr,e[nr+1]=tr}}else{var or=$-H,sr=L-G;e[_]=or,e[_+1]=sr}}}},r.prototype._singleRealTransform2=function(r,t,e){const n=this._out,o=this._data,s=o[t],i=o[t+e],a=s+i,u=s-i;n[r]=a,n[r+1]=0,n[r+2]=u,n[r+3]=0},r.prototype._singleRealTransform4=function(r,t,e){const n=this._out,o=this._data,s=this._inv?-1:1,i=2*e,a=3*e,u=o[t],l=o[t+e],h=o[t+i],f=o[t+a],c=u+h,d=u-h,m=l+f,p=s*(l-f),_=c+m,g=d,b=-p,y=c-m,v=d,x=p;n[r]=_,n[r+1]=0,n[r+2]=g,n[r+3]=b,n[r+4]=y,n[r+5]=0,n[r+6]=v,n[r+7]=x},w}());class B{_inputLength;_fft;_bufferSupplier;_paddedInputBuffer;_transformBuffer;_inverseBuffer;static forFloat32Array(r){return new B(r,r=>new Float32Array(r))}static forFloat64Array(r){return new B(r,r=>new Float64Array(r))}static forNumberArray(r){return new B(r,r=>Array(r))}constructor(r,t){if(r<1)throw new Error("Input length must be at least one");var e;this._inputLength=r,this._fft=new j((e=2*r,e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}get inputLength(){return this._inputLength}autocorrelate(r,t=this._bufferSupplier(r.length)){if(r.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${r.length}`);for(let n=0;n<r.length;n++)this._paddedInputBuffer[n]=r[n];for(let n=r.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const e=this._transformBuffer;for(let n=0;n<e.length;n+=2)e[n]=e[n]*e[n]+e[n+1]*e[n+1],e[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<r.length;n++)t[n]=this._inverseBuffer[2*n];return t}}class S{_autocorrelator;_nsdfBuffer;_clarityThreshold=.9;_minVolumeAbsolute=0;_maxInputAmplitude=1;static forFloat32Array(r){return new S(r,r=>new Float32Array(r))}static forFloat64Array(r){return new S(r,r=>new Float64Array(r))}static forNumberArray(r){return new S(r,r=>Array(r))}constructor(r,t){this._autocorrelator=new B(r,t),this._nsdfBuffer=t(r)}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(r){if(!Number.isFinite(r)||r<=0||r>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=r}set minVolumeAbsolute(r){if(!Number.isFinite(r)||r<0||r>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=r}set minVolumeDecibels(r){if(!Number.isFinite(r)||r>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(r/10)}set maxInputAmplitude(r){if(!Number.isFinite(r)||r<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=r}findPitch(r,t){if(this._belowMinimumVolume(r))return[0,0];this._nsdf(r);const e=function(r){const t=[];let e=!1,n=-1/0,o=-1;for(let s=1;s<r.length-1;s++)r[s-1]<=0&&r[s]>0?(e=!0,o=s,n=r[s]):r[s-1]>0&&r[s]<=0?(e=!1,-1!==o&&t.push(o)):e&&r[s]>n&&(n=r[s],o=s);return t}(this._nsdfBuffer);if(0===e.length)return[0,0];const n=Math.max(...e.map(r=>this._nsdfBuffer[r])),o=e.find(r=>this._nsdfBuffer[r]>=this._clarityThreshold*n),[s,i]=function(r,t){const[e,n,o]=[r-1,r,r+1],[s,i,a]=[t[e],t[n],t[o]],u=s/2-i+a/2,l=-s/2*(n+o)+i*(e+o)-a/2*(e+n),h=-l/(2*u);return[h,u*h*h+l*h+(s*n*o/2-i*e*o+a*e*n/2)]}(o,this._nsdfBuffer);return[t/s,Math.min(i,1)]}_belowMinimumVolume(r){if(0===this._minVolumeAbsolute)return!1;let t=0;for(let e=0;e<r.length;e++)t+=r[e]**2;return Math.sqrt(t/r.length)<this._minVolumeAbsolute}_nsdf(r){this._autocorrelator.autocorrelate(r,this._nsdfBuffer);let t,e=2*this._nsdfBuffer[0];for(t=0;t<this._nsdfBuffer.length&&e>0;t++)this._nsdfBuffer[t]=2*this._nsdfBuffer[t]/e,e-=r[t]**2+r[r.length-t-1]**2;for(;t<this._nsdfBuffer.length;t++)this._nsdfBuffer[t]=0}}const T=r=>{const[t,e]=p.useState("-"),[n,o]=p.useState(null),[s,i]=p.useState(!1),a=p.useRef(null),u=p.useRef(null),l=p.useRef(null),h=p.useRef(null),f=p.useRef(null),c=p.useRef(null),d=()=>{if(!(a.current&&u.current&&l.current&&h.current))return;const t=u.current,n=l.current,s=h.current;t.getFloatTimeDomainData(s);const[i,c]=n.findPitch(s,a.current.sampleRate);i&&c>.9&&(o(i),e(((r,t)=>{let e=t[0],n=Math.abs(r-e.freq);for(const o of t){const t=Math.abs(r-o.freq);t<n&&(e=o,n=t)}return e.name})(i,r))),f.current=requestAnimationFrame(d)};return{note:t,frequency:n,isRunning:s,startTuner:async()=>{if(!s)try{const r=await navigator.mediaDevices.getUserMedia({audio:!0});c.current=r;const t=new AudioContext;a.current=t;const e=t.createMediaStreamSource(r),n=t.createAnalyser();n.fftSize=2048,u.current=n,e.connect(n);const o=S.forFloat32Array(n.fftSize);l.current=o,h.current=new Float32Array(n.fftSize),i(!0),d()}catch(r){alert(`[!] Error accessing microphone: ${r}`),console.error("Error accessing microphone",r)}},stopTuner:()=>{s&&(null!==f.current&&cancelAnimationFrame(f.current),a.current?.close(),c.current?.getTracks().forEach(r=>r.stop()),f.current=null,a.current=null,c.current=null,u.current=null,l.current=null,h.current=null,i(!1),e("-"),o(null))}}},C=e=>{const n=g(r=>r.appTheme.appMenu.items.tuner);return r.jsx(t,{"aria-label":"play-pause tuner",icon:e.isRunning?r.jsx(b,{}):r.jsx(y,{}),onClick:e.isRunning?e.onStop:e.onStart,mb:"10px",size:"lg",backgroundColor:n.controlButton.background,color:n.controlButton.color,_hover:{backgroundColor:n.controlButton.hover.background,color:n.controlButton.hover.color}})},z=t=>{const n=g(r=>r.appTheme.appMenu.items.tuner);return r.jsx(e,{...t.containerProps,fontWeight:"bold",color:n.frequencyDisplay.color,children:null!==t.freq?`(${t.freq?.toFixed(2)} Hz)`:"(0 Hz)"})},F=t=>{const e=g(r=>r.appTheme.appMenu.items.tuner),i=t.targetFreq-t.currentFreq,a=Math.abs(i),u=a<=t.threshold,l=i>0,h=u?e.frequencyProgressIndicator.matched:l?e.frequencyProgressIndicator.tuneUp:e.frequencyProgressIndicator.tuneDown;return r.jsx(n,{...t.containerProps,justifyContent:"center",children:r.jsx(o,{size:"12",borderWidth:"thin",fontWeight:"bold",color:h.color,backgroundColor:h.background,borderColor:h.border,children:t.active?u?r.jsx(s,{as:v}):`${l?"+":"-"}${a.toFixed(0)}`:"0"})})},q=t=>{const e=g(r=>r.appTheme.appMenu.items.tuner);return r.jsxs(i,{...t.containerProps,columns:[1,2],gap:"5px",children:[r.jsxs(a,{size:"sm",as:"h5",color:e.thresholdSlider.color,children:["Frequency Threshold",r.jsx("br",{})," ",t.threshold," Hz"]}),r.jsxs(u,{value:t.threshold,onChange:r=>t.onThresholdChange(r),min:0,max:5,step:.1,children:[r.jsx(l,{backgroundColor:e.thresholdSlider.slider.track,children:r.jsx(h,{backgroundColor:e.thresholdSlider.slider.filler})}),r.jsx(f,{label:`${t.threshold} Hz`,fontWeight:"bold",backgroundColor:e.thresholdSlider.slider.tooltip.background,color:e.thresholdSlider.slider.tooltip.color,children:r.jsx(c,{backgroundColor:e.thresholdSlider.slider.thumb})})]})]})},I=t=>{const e=g(r=>r.appTheme.appMenu.items.tuner),s=t.active?e.strings.active:e.strings.inactive;return r.jsxs(n,{direction:"column",alignItems:"center",justifyContent:"center",position:"relative",as:"button",onClick:t.onClick,children:[r.jsx(o,{size:"10",fontWeight:"bold",borderWidth:"3px",color:s.noteColor,borderColor:s.noteBorderColor,backgroundColor:s.backgroundColor,children:t.name}),r.jsx(d,{orientation:"vertical",height:"125px",borderWidth:"2px",borderColor:s.stringColor})]})},k=["E","A","D","G","B","e"],E=t=>r.jsx(n,{...t.containerProps,direction:"row",gap:"10px",justifyContent:"center",children:k.map((e,n)=>r.jsx(I,{name:e,active:e===t.activeString,onClick:()=>t.onStringClick(e)},n))}),M=[{name:"E2",freq:82.41},{name:"A2",freq:110},{name:"D3",freq:146.83},{name:"G3",freq:196},{name:"B3",freq:246.94},{name:"E4",freq:329.63}],R={E:0,A:1,D:2,G:3,B:4,e:5},P=()=>{const t=T(M),[o,s]=((r,t)=>{const[e,n]=p.useState(()=>{try{const e=window.localStorage.getItem(r);if(e){const r=JSON.parse(e);return"object"==typeof t&&null!==t&&"object"==typeof r&&null!==r&&!Array.isArray(t)&&Array.isArray(r),r}return t}catch(e){return console.warn(`Error reading localStorage key "${r}":`,e),t}});return p.useEffect(()=>{try{window.localStorage.setItem(r,JSON.stringify(e))}catch(t){console.warn(`Error setting localStorage key "${r}":`,t)}},[r,e]),[e,n]})(x.tunerThreshold,2),[i,a]=p.useState(null),u=g(r=>r.appTheme.appMenu.items.tuner);return r.jsxs(e,{textAlign:"center",borderRadius:"5px",children:[r.jsx(d,{borderColor:u.divider}),r.jsxs(m,{gridTemplateColumns:["1fr 1fr"],alignItems:"center",padding:"0 2rem",children:[r.jsx(e,{children:r.jsx(C,{isRunning:t.isRunning,onStart:()=>{t.startTuner(),a("E")},onStop:()=>{t.stopTuner(),a(null)}})}),r.jsxs(n,{direction:"column",padding:"1rem 0",children:[r.jsx(z,{freq:t.frequency,containerProps:{mb:"0.7rem"}}),r.jsx(F,{active:null!==i&&t.isRunning,currentFreq:t.frequency||0,targetFreq:M[R[i||"E"]].freq,threshold:o,containerProps:{mb:"1rem"}})]})]}),r.jsx(d,{borderColor:u.divider,mb:"1rem"}),r.jsx(E,{activeString:i,onStringClick:r=>a(r),containerProps:{mb:"1rem"}}),r.jsx(d,{borderColor:u.divider,mb:"1rem"}),r.jsx(q,{threshold:o,onThresholdChange:s})]})};export{P as GuitarTuner,P as default};
