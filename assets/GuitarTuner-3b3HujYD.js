import{j as r,a1 as t,B as e,F as n,w as o,r as s,Z as i,H as a,a2 as u,a3 as l,a4 as h,O as f,a5 as c,n as d,a6 as m}from"./chakra-BupWi6oY.js";import{g as p,r as _}from"./react-C2u2R5M2.js";import{a as g,b,L as v}from"./index-ewyDKez2.js";import{b as x,c as y,d as w}from"./react-icons-DdyG56US.js";import"./framer-motion-CuZlN0Cr.js";import"./react-virtualized-BgeJ7yGI.js";import"./react-intersection-observer-C8kgPgtE.js";var A,j;const B=p(function(){if(j)return A;function r(r){if(this.size=0|r,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=r<<1;for(var t=new Array(2*this.size),e=0;e<t.length;e+=2){const r=Math.PI*e/this.size;t[e]=Math.cos(r),t[e+1]=-Math.sin(r)}this.table=t;for(var n=0,o=1;this.size>o;o<<=1)n++;this._width=n%2==0?n-1:n,this._bitrev=new Array(1<<this._width);for(var s=0;s<this._bitrev.length;s++){this._bitrev[s]=0;for(var i=0;i<this._width;i+=2){var a=this._width-i-2;this._bitrev[s]|=(s>>>i&3)<<a}}this._out=null,this._data=null,this._inv=0}return j=1,A=r,r.prototype.fromComplexArray=function(r,t){for(var e=t||new Array(r.length>>>1),n=0;n<r.length;n+=2)e[n>>>1]=r[n];return e},r.prototype.createComplexArray=function(){const r=new Array(this._csize);for(var t=0;t<r.length;t++)r[t]=0;return r},r.prototype.toComplexArray=function(r,t){for(var e=t||this.createComplexArray(),n=0;n<e.length;n+=2)e[n]=r[n>>>1],e[n+1]=0;return e},r.prototype.completeSpectrum=function(r){for(var t=this._csize,e=t>>>1,n=2;n<e;n+=2)r[t-n]=r[n],r[t-n+1]=-r[n+1]},r.prototype.transform=function(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null},r.prototype.realTransform=function(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null},r.prototype.inverseTransform=function(r,t){if(r===t)throw new Error("Input and output buffers must be different");this._out=r,this._data=t,this._inv=1,this._transform4();for(var e=0;e<r.length;e++)r[e]/=this.size;this._out=null,this._data=null},r.prototype._transform4=function(){var r,t,e=this._out,n=this._csize,o=1<<this._width,s=n/o<<1,i=this._bitrev;if(4===s)for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleTransform2(r,e,o)}else for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleTransform4(r,e,o)}var a=this._inv?-1:1,u=this.table;for(o>>=2;o>=2;o>>=2){var l=(s=n/o<<1)>>>2;for(r=0;r<n;r+=s)for(var h=r+l,f=r,c=0;f<h;f+=2,c+=o){const r=f,t=r+l,n=t+l,o=n+l,s=e[r],i=e[r+1],h=e[t],d=e[t+1],m=e[n],p=e[n+1],_=e[o],g=e[o+1],b=s,v=i,x=u[c],y=a*u[c+1],w=h*x-d*y,A=h*y+d*x,j=u[2*c],B=a*u[2*c+1],C=m*j-p*B,S=m*B+p*j,T=u[3*c],z=a*u[3*c+1],F=_*T-g*z,q=_*z+g*T,I=b+C,k=v+S,E=b-C,M=v-S,R=w+F,P=A+q,V=a*(w-F),D=a*(A-q),L=I+R,$=k+P,W=I-R,N=k-P,H=E+D,G=M-V,U=E-D,O=M+V;e[r]=L,e[r+1]=$,e[t]=H,e[t+1]=G,e[n]=W,e[n+1]=N,e[o]=U,e[o+1]=O}}},r.prototype._singleTransform2=function(r,t,e){const n=this._out,o=this._data,s=o[t],i=o[t+1],a=o[t+e],u=o[t+e+1],l=s+a,h=i+u,f=s-a,c=i-u;n[r]=l,n[r+1]=h,n[r+2]=f,n[r+3]=c},r.prototype._singleTransform4=function(r,t,e){const n=this._out,o=this._data,s=this._inv?-1:1,i=2*e,a=3*e,u=o[t],l=o[t+1],h=o[t+e],f=o[t+e+1],c=o[t+i],d=o[t+i+1],m=o[t+a],p=o[t+a+1],_=u+c,g=l+d,b=u-c,v=l-d,x=h+m,y=f+p,w=s*(h-m),A=s*(f-p),j=_+x,B=g+y,C=b+A,S=v-w,T=_-x,z=g-y,F=b-A,q=v+w;n[r]=j,n[r+1]=B,n[r+2]=C,n[r+3]=S,n[r+4]=T,n[r+5]=z,n[r+6]=F,n[r+7]=q},r.prototype._realTransform4=function(){var r,t,e=this._out,n=this._csize,o=1<<this._width,s=n/o<<1,i=this._bitrev;if(4===s)for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleRealTransform2(r,e>>>1,o>>>1)}else for(r=0,t=0;r<n;r+=s,t++){const e=i[t];this._singleRealTransform4(r,e>>>1,o>>>1)}var a=this._inv?-1:1,u=this.table;for(o>>=2;o>=2;o>>=2){var l=(s=n/o<<1)>>>1,h=l>>>1,f=h>>>1;for(r=0;r<n;r+=s)for(var c=0,d=0;c<=f;c+=2,d+=o){var m=r+c,p=m+h,_=p+h,g=_+h,b=e[m],v=e[m+1],x=e[p],y=e[p+1],w=e[_],A=e[_+1],j=e[g],B=e[g+1],C=b,S=v,T=u[d],z=a*u[d+1],F=x*T-y*z,q=x*z+y*T,I=u[2*d],k=a*u[2*d+1],E=w*I-A*k,M=w*k+A*I,R=u[3*d],P=a*u[3*d+1],V=j*R-B*P,D=j*P+B*R,L=C+E,$=S+M,W=C-E,N=S-M,H=F+V,G=q+D,U=a*(F-V),O=a*(q-D),Z=L+H,J=$+G,K=W+O,Q=N-U;if(e[m]=Z,e[m+1]=J,e[p]=K,e[p+1]=Q,0!==c){if(c!==f){var X=W+-a*O,Y=-N+-a*U,rr=L+-a*H,tr=-$- -a*G,er=r+h-c,nr=r+l-c;e[er]=X,e[er+1]=Y,e[nr]=rr,e[nr+1]=tr}}else{var or=L-H,sr=$-G;e[_]=or,e[_+1]=sr}}}},r.prototype._singleRealTransform2=function(r,t,e){const n=this._out,o=this._data,s=o[t],i=o[t+e],a=s+i,u=s-i;n[r]=a,n[r+1]=0,n[r+2]=u,n[r+3]=0},r.prototype._singleRealTransform4=function(r,t,e){const n=this._out,o=this._data,s=this._inv?-1:1,i=2*e,a=3*e,u=o[t],l=o[t+e],h=o[t+i],f=o[t+a],c=u+h,d=u-h,m=l+f,p=s*(l-f),_=c+m,g=d,b=-p,v=c-m,x=d,y=p;n[r]=_,n[r+1]=0,n[r+2]=g,n[r+3]=b,n[r+4]=v,n[r+5]=0,n[r+6]=x,n[r+7]=y},A}());class C{_inputLength;_fft;_bufferSupplier;_paddedInputBuffer;_transformBuffer;_inverseBuffer;static forFloat32Array(r){return new C(r,r=>new Float32Array(r))}static forFloat64Array(r){return new C(r,r=>new Float64Array(r))}static forNumberArray(r){return new C(r,r=>Array(r))}constructor(r,t){if(r<1)throw new Error("Input length must be at least one");var e;this._inputLength=r,this._fft=new B((e=2*r,e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}get inputLength(){return this._inputLength}autocorrelate(r,t=this._bufferSupplier(r.length)){if(r.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${r.length}`);for(let n=0;n<r.length;n++)this._paddedInputBuffer[n]=r[n];for(let n=r.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const e=this._transformBuffer;for(let n=0;n<e.length;n+=2)e[n]=e[n]*e[n]+e[n+1]*e[n+1],e[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<r.length;n++)t[n]=this._inverseBuffer[2*n];return t}}class S{_autocorrelator;_nsdfBuffer;_clarityThreshold=.9;_minVolumeAbsolute=0;_maxInputAmplitude=1;static forFloat32Array(r){return new S(r,r=>new Float32Array(r))}static forFloat64Array(r){return new S(r,r=>new Float64Array(r))}static forNumberArray(r){return new S(r,r=>Array(r))}constructor(r,t){this._autocorrelator=new C(r,t),this._nsdfBuffer=t(r)}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(r){if(!Number.isFinite(r)||r<=0||r>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=r}set minVolumeAbsolute(r){if(!Number.isFinite(r)||r<0||r>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=r}set minVolumeDecibels(r){if(!Number.isFinite(r)||r>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(r/10)}set maxInputAmplitude(r){if(!Number.isFinite(r)||r<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=r}findPitch(r,t){if(this._belowMinimumVolume(r))return[0,0];this._nsdf(r);const e=function(r){const t=[];let e=!1,n=-1/0,o=-1;for(let s=1;s<r.length-1;s++)r[s-1]<=0&&r[s]>0?(e=!0,o=s,n=r[s]):r[s-1]>0&&r[s]<=0?(e=!1,-1!==o&&t.push(o)):e&&r[s]>n&&(n=r[s],o=s);return t}(this._nsdfBuffer);if(0===e.length)return[0,0];const n=Math.max(...e.map(r=>this._nsdfBuffer[r])),o=e.find(r=>this._nsdfBuffer[r]>=this._clarityThreshold*n),[s,i]=function(r,t){const[e,n,o]=[r-1,r,r+1],[s,i,a]=[t[e],t[n],t[o]],u=s/2-i+a/2,l=-s/2*(n+o)+i*(e+o)-a/2*(e+n),h=-l/(2*u);return[h,u*h*h+l*h+(s*n*o/2-i*e*o+a*e*n/2)]}(o,this._nsdfBuffer);return[t/s,Math.min(i,1)]}_belowMinimumVolume(r){if(0===this._minVolumeAbsolute)return!1;let t=0;for(let e=0;e<r.length;e++)t+=r[e]**2;return Math.sqrt(t/r.length)<this._minVolumeAbsolute}_nsdf(r){this._autocorrelator.autocorrelate(r,this._nsdfBuffer);let t,e=2*this._nsdfBuffer[0];for(t=0;t<this._nsdfBuffer.length&&e>0;t++)this._nsdfBuffer[t]=2*this._nsdfBuffer[t]/e,e-=r[t]**2+r[r.length-t-1]**2;for(;t<this._nsdfBuffer.length;t++)this._nsdfBuffer[t]=0}}const T=r=>{const[t,e]=_.useState("-"),[n,o]=_.useState(null),[s,i]=_.useState(!1),a=_.useRef(null),u=_.useRef(null),l=_.useRef(null),h=_.useRef(null),f=_.useRef(null),c=_.useRef(null),d=()=>{if(!(a.current&&u.current&&l.current&&h.current))return;const t=u.current,n=l.current,s=h.current;t.getFloatTimeDomainData(s);const[i,c]=n.findPitch(s,a.current.sampleRate);i&&c>.9&&(o(i),e(((r,t)=>{let e=t[0],n=Math.abs(r-e.freq);for(const o of t){const t=Math.abs(r-o.freq);t<n&&(e=o,n=t)}return e.name})(i,r))),f.current=requestAnimationFrame(d)};return{note:t,frequency:n,isRunning:s,startTuner:async()=>{if(!s)try{const r=await navigator.mediaDevices.getUserMedia({audio:!0});c.current=r;const t=new AudioContext;a.current=t;const e=t.createMediaStreamSource(r),n=t.createAnalyser();n.fftSize=2048,u.current=n,e.connect(n);const o=S.forFloat32Array(n.fftSize);l.current=o,h.current=new Float32Array(n.fftSize),i(!0),d()}catch(r){alert(`[!] Error accessing microphone: ${r}`),console.error("Error accessing microphone",r)}},stopTuner:()=>{s&&(null!==f.current&&cancelAnimationFrame(f.current),a.current?.close(),c.current?.getTracks().forEach(r=>r.stop()),f.current=null,a.current=null,c.current=null,u.current=null,l.current=null,h.current=null,i(!1),e("-"),o(null))}}},z=e=>{const{appMenu:{items:{tuner:n}}}=g();return r.jsx(t,{"aria-label":"play-pause tuner",icon:e.isRunning?r.jsx(x,{}):r.jsx(y,{}),onClick:e.isRunning?e.onStop:e.onStart,mb:"10px",size:"lg",backgroundColor:n.controlButton.background,color:n.controlButton.color,_hover:{backgroundColor:n.controlButton.hover.background,color:n.controlButton.hover.color}})},F=t=>{const{appMenu:{items:{tuner:n}}}=g();return r.jsx(e,{...t.containerProps,fontWeight:"bold",color:n.frequencyDisplay.color,children:null!==t.freq?`(${t.freq?.toFixed(2)} Hz)`:"(0 Hz)"})},q=t=>{const{appMenu:{items:{tuner:e}}}=g(),i=t.targetFreq-t.currentFreq,a=Math.abs(i),u=a<=t.threshold,l=i>0,h=u?e.frequencyProgressIndicator.matched:l?e.frequencyProgressIndicator.tuneUp:e.frequencyProgressIndicator.tuneDown;return r.jsx(n,{...t.containerProps,justifyContent:"center",children:r.jsx(o,{size:"12",borderWidth:"thin",fontWeight:"bold",color:h.color,backgroundColor:h.background,borderColor:h.border,children:t.active?u?r.jsx(s,{as:w}):`${l?"+":"-"}${a.toFixed(0)}`:"0"})})},I=t=>{const{appMenu:{items:{tuner:e}}}=g();return r.jsxs(i,{...t.containerProps,columns:[1,2],gap:"5px",children:[r.jsxs(a,{size:"sm",as:"h5",color:e.thresholdSlider.color,children:["Frequency Threshold",r.jsx("br",{})," ",t.threshold," Hz"]}),r.jsxs(u,{value:t.threshold,onChange:r=>t.onThresholdChange(r),min:0,max:5,step:.1,children:[r.jsx(l,{backgroundColor:e.thresholdSlider.slider.track,children:r.jsx(h,{backgroundColor:e.thresholdSlider.slider.filler})}),r.jsx(f,{label:`${t.threshold} Hz`,fontWeight:"bold",backgroundColor:e.thresholdSlider.slider.tooltip.background,color:e.thresholdSlider.slider.tooltip.color,children:r.jsx(c,{backgroundColor:e.thresholdSlider.slider.thumb})})]})]})},k=t=>{const{appMenu:{items:{tuner:e}}}=g(),s=t.active?e.strings.active:e.strings.inactive;return r.jsxs(n,{direction:"column",alignItems:"center",justifyContent:"center",position:"relative",as:"button",onClick:t.onClick,children:[r.jsx(o,{size:"10",fontWeight:"bold",borderWidth:"3px",color:s.noteColor,borderColor:s.noteBorderColor,backgroundColor:s.backgroundColor,children:t.name}),r.jsx(d,{orientation:"vertical",height:"125px",borderWidth:"2px",borderColor:s.stringColor})]})},E=["E","A","D","G","B","e"],M=t=>r.jsx(n,{...t.containerProps,direction:"row",gap:"10px",justifyContent:"center",children:E.map((e,n)=>r.jsx(k,{name:e,active:e===t.activeString,onClick:()=>t.onStringClick(e)},n))}),R=[{name:"E2",freq:82.41},{name:"A2",freq:110},{name:"D3",freq:146.83},{name:"G3",freq:196},{name:"B3",freq:246.94},{name:"E4",freq:329.63}],P={E:0,A:1,D:2,G:3,B:4,e:5},V=()=>{const t=T(R),{appMenu:{items:{tuner:o}}}=g(),[s,i]=b(v.tunerThreshold,2),[a,u]=_.useState(null);return r.jsxs(e,{textAlign:"center",borderRadius:"5px",children:[r.jsx(d,{borderColor:o.divider}),r.jsxs(m,{gridTemplateColumns:["1fr 1fr"],alignItems:"center",padding:"0 2rem",children:[r.jsx(e,{children:r.jsx(z,{isRunning:t.isRunning,onStart:()=>{t.startTuner(),u("E")},onStop:()=>{t.stopTuner(),u(null)}})}),r.jsxs(n,{direction:"column",padding:"1rem 0",children:[r.jsx(F,{freq:t.frequency,containerProps:{mb:"0.7rem"}}),r.jsx(q,{active:null!==a&&t.isRunning,currentFreq:t.frequency||0,targetFreq:R[P[a||"E"]].freq,threshold:s,containerProps:{mb:"1rem"}})]})]}),r.jsx(d,{borderColor:o.divider,mb:"1rem"}),r.jsx(M,{activeString:a,onStringClick:r=>u(r),containerProps:{mb:"1rem"}}),r.jsx(d,{borderColor:o.divider,mb:"1rem"}),r.jsx(I,{threshold:s,onThresholdChange:i})]})};export{V as GuitarTuner,V as default};
